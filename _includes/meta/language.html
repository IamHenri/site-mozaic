{% assign all_pages = site.pages %}
{% for collection in site.collections %}
{% assign all_pages = all_pages | concat: collection.docs %}
{% endfor %}

{% for lang in site.languages %}
{% assign alt_prefix = '/' | append: lang | append: '/' %}
{% assign current_prefix = '/' | append: page.lang | append: '/' %}
{% assign alt_url = page.url | replace_first: current_prefix, alt_prefix %}
{% assign alt_page = all_pages | where: "url", alt_url | first %}
{% if alt_page and page.url != '/' %}
<link rel="alternate" hreflang="{{ lang }}" href="{{ site.url }}{{ alt_page.url }}" />
{% endif %}
{% endfor %}

<script>
(function() {
  // 1Ô∏è‚É£ Ne pas ex√©cuter pour les bots
  if (/bot|crawl|spider/i.test(navigator.userAgent)) return;

  // 2Ô∏è‚É£ Langue de la page actuelle
  const currentLang = '{{ lang }}';

  // 3Ô∏è‚É£ Langue stock√©e (choix utilisateur)
  const storedLang = localStorage.getItem('lang');

  // 4Ô∏è‚É£ Langue du navigateur (ex: 'fr-FR' ‚Üí 'fr')
  const browserLang = (navigator.language || navigator.userLanguage || 'en').split('-')[0];

  // 5Ô∏è‚É£ Langue cible : priorit√© au choix utilisateur, sinon langue navigateur
  const preferredLang = storedLang || browserLang;

  // üß≠ V√©rifie si on arrive depuis l'ext√©rieur du site
  const fromSameSite = document.referrer && document.referrer.includes(window.location.origin);

  // 6Ô∏è‚É£ Si premi√®re visite (pas encore stock√©e)
  if (!storedLang) {
    // On sauvegarde automatiquement la langue du navigateur
    localStorage.setItem('lang', preferredLang);
  }

  // 7Ô∏è‚É£ Redirection automatique uniquement si :
  // - la langue du navigateur ‚â† langue de la page
  // - l'utilisateur n‚Äôa pas d√©j√† fait un choix (pas de redirection si storedLang existe)
  if ((!fromSameSite || !storedLang) && preferredLang !== currentLang) {
    const targetPath = preferredLang === 'fr' ? '/fr/' : '/';
    if (!window.location.pathname.startsWith(targetPath)) {
      window.location.href = targetPath;
    }
  }
})();
</script>